<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hybrid AI Engine</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
    font-family:system-ui;
    background:#0f172a;
    color:white;
    display:flex;
    flex-direction:column;
    height:100vh;
}
header{
    padding:15px;
    background:#1e293b;
    text-align:center;
    font-weight:bold;
}
#chat{
    flex:1;
    overflow-y:auto;
    padding:20px;
}
.message{margin-bottom:20px;}
.user{text-align:right;}
.bubble{
    display:inline-block;
    padding:12px 16px;
    border-radius:12px;
    max-width:80%;
    line-height:1.6;
}
.user .bubble{background:#2563eb;}
.ai .bubble{background:#1e293b;}
#inputArea{
    display:flex;
    padding:15px;
    background:#1e293b;
}
input{
    flex:1;
    padding:12px;
    border-radius:8px;
    border:none;
    background:#0f172a;
    color:white;
}
button{
    margin-left:10px;
    padding:12px 18px;
    border-radius:8px;
    border:none;
    background:#2563eb;
    color:white;
    cursor:pointer;
}
button:hover{background:#1d4ed8;}
.typing{opacity:0.6;font-style:italic;}
.source{
    font-size:12px;
    opacity:0.7;
    margin-top:8px;
}
</style>
</head>

<body>

<header>Hybrid AI (Ranked + Voice + Citations)</header>
<div id="chat"></div>

<div id="inputArea">
    <input id="userInput" placeholder="Ask something..." />
    <button onclick="sendMessage()">Send</button>
    <button onclick="startVoice()">ðŸŽ¤</button>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("userInput");

input.addEventListener("keypress", e=>{
    if(e.key==="Enter") sendMessage();
});

function addMessage(content,sender){
    const msg=document.createElement("div");
    msg.className="message "+sender;
    const bubble=document.createElement("div");
    bubble.className="bubble";
    bubble.innerHTML=content;
    msg.appendChild(bubble);
    chat.appendChild(msg);
    chat.scrollTop=chat.scrollHeight;
    return bubble;
}

/* ----------- Wikipedia ----------- */
async function fetchWikipedia(query){
    try{
        const res=await fetch(
            `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`
        );
        const data=await res.json();
        return data.extract||"";
    }catch{return "";}
}

/* ----------- GitHub HTML Extraction ----------- */
async function fetchGitHubContent(){
    try{
        const res=await fetch("https://hanuveer1904.github.io/jsqb.html");
        const html=await res.text();
        const parser=new DOMParser();
        const doc=parser.parseFromString(html,"text/html");

        // Remove scripts/styles
        doc.querySelectorAll("script,style").forEach(el=>el.remove());

        return doc.body.innerText;
    }catch{return "";}
}

/* ----------- Relevance Scoring ----------- */
function scoreContent(content,query){
    const words=query.toLowerCase().split(" ");
    let score=0;
    words.forEach(w=>{
        const regex=new RegExp(w,"gi");
        const matches=content.match(regex);
        if(matches) score+=matches.length;
    });
    return score;
}

/* ----------- Rewrite AI Style ----------- */
function rewriteAnswer(query,wiki,github){
    let combined="";
    if(wiki) combined+=wiki+"\n\n";
    if(github) combined+=github.substring(0,800);

    return `
### Answer to: "${query}"

${combined}

---
**Summary:**  
The information above was retrieved, ranked by relevance, and combined into a structured response.
`;
}

/* ----------- Main Send ----------- */
async function sendMessage(){
    const text=input.value.trim();
    if(!text) return;

    addMessage(text,"user");
    input.value="";

    const bubble=addMessage("Analyzing sources...","ai");
    bubble.classList.add("typing");

    const wiki=await fetchWikipedia(text);
    const githubContent=await fetchGitHubContent();

    const wikiScore=scoreContent(wiki,text);
    const githubScore=scoreContent(githubContent,text);

    let rankedWiki=wiki;
    let rankedGitHub=githubContent;

    if(githubScore>wikiScore){
        [rankedWiki,rankedGitHub]=[rankedGitHub,rankedWiki];
    }

    const finalAnswer=rewriteAnswer(text,rankedWiki,rankedGitHub);

    bubble.classList.remove("typing");
    bubble.innerHTML=marked.parse(finalAnswer+`

<div class="source">
Sources:<br>
[1] Wikipedia<br>
[2] hanuveer1904.github.io/jsqb.html
</div>
`);

    document.querySelectorAll("pre code").forEach(block=>{
        hljs.highlightElement(block);
    });
}

/* ----------- Voice Input ----------- */
function startVoice(){
    if(!('webkitSpeechRecognition' in window)){
        alert("Voice not supported in this browser.");
        return;
    }
    const recognition=new webkitSpeechRecognition();
    recognition.lang="en-US";
    recognition.start();

    recognition.onresult=function(event){
        input.value=event.results[0][0].transcript;
    };
}
</script>

</body>
</html>
